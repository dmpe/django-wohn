# Fetch secrets from "Library"
variables:
- group: VarGroup1

pool:
  vmImage: "windows-latest"

trigger:
  - docs

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'
    addToPath: true
    architecture: 'x64'

- checkout: self
  persistCredentials: true

- script: python -m pip install --upgrade pip setuptools wheel
  displayName: 'Install tools'

- script: |
    git config --global user.email "cincenko@outlook.com"
    git config --global user.name "dmpe"
    pip3 install mkdocs mkdocs-material
    mkdocs --version
  displayName: Install PIP packages and print mkdocs version

#    md $(Build.SourcesDirectory)\outcomes -ea 0
#    Copy-Item -Path site\ -Destination $(Build.SourcesDirectory)\outcomes -Recurse

- pwsh: |
    dir
    mkdocs build
    dir 
  displayName: Build site folder

- pwsh: |
    $ErrorActionPreference = "Continue" 
    cd $(Build.StagingDirectory)
    $var1 = $env:GitHubPAT
    git clone https://dmpe:$var1@github.com/dmpe/django-wohn.git .
    git checkout gh-pages
    Copy-Item -Path $(Build.SourcesDirectory)\site\* -Destination . -Recurse -Force -Verbose
    Write-Host "Done here"

- pwsh: |
    Set-PSDebug -Trace 2;
    git config credential.helper
    git config --global credential.helper manager
    cd $(Build.StagingDirectory) 
    dir
    git checkout gh-pages
    git add --all
    git commit -a -m "Azure Pipeline MkDocs Build and Push"
    git remote -v
    #git remote add origin https://dmpe:$(GitHubPAT)@github.com/dmpe/django-wohn.git
    git push https://dmpe:$(GitHubPAT)@github.com/dmpe/django-wohn.git gh-pages


